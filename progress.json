{
  "project": "cim-keys-architectural-refactoring",
  "version": "2.0.0",
  "created": "2025-12-28",
  "last_updated": "2025-12-29",
  "backward_compatibility": false,
  "notes": "User confirmed: NO backward compatibility required. Overwrite existing APIs freely.",

  "previous_work": {
    "phase": "GUI Domain Import Fix",
    "status": "completed",
    "summary": "Fixed Import from Secrets to build full graph with org, units, people, and edges",
    "completed_date": "2025-12-29"
  },

  "expert_consultations": {
    "prior_consultations": {
      "elm-architecture-expert": {
        "key_points": [
          "Intent types prefixed by origin: Ui*, Port*, Domain*, Error*",
          "Model must have pure with_* update methods",
          "Update function: (Model, Intent) → (Model, Command)",
          "Graph building is pure function - no I/O"
        ]
      },
      "iced-ui-expert": {
        "key_points": [
          "File I/O is async → use Task::perform",
          "Graph building is synchronous in update()",
          "Order matters: Orgs → Units → Locations → People → Edges"
        ]
      },
      "cim-expert-prior": {
        "key_points": [
          "Use domain-bootstrap.json as canonical format",
          "Relationships are first-class with RelationshipType enum",
          "Validate PKI prerequisites before generation"
        ]
      }
    },
    "refactoring_consultations": {
      "ddd_expert": {
        "agent_id": "a996ff8",
        "date": "2025-12-29",
        "critical_findings": [
          "OrganizationGraph → OrganizationConcept (Graph is implementation, not domain)",
          "GraphNode → ConceptEntity (Technical term, not ubiquitous language)",
          "NodeType enum violates DDD - Person IS a Person, not 'type of node'",
          "GraphMessage → OrganizationIntent (conflates UI events with domain ops)"
        ],
        "validation_checklist": {
          "uses_ubiquitous_language": false,
          "domain_expert_understands": false,
          "is_concept_not_graph": false,
          "implements_liftable_domain": false,
          "entities_preserved": false
        }
      },
      "conceptual_spaces_expert": {
        "agent_id": "a4d2f1b",
        "date": "2025-12-29",
        "critical_findings": [
          "Position should be Point3<f64> on unit sphere, not 2D screen Point",
          "Need KnowledgeLevel (Unknown/Suspected/KnownUnknown/Known)",
          "Need evidence_cids: Vec<String> and confidence: f64",
          "Boundaries should use Voronoi tessellation, not manual edges",
          "Topology needs evolution state machine"
        ],
        "key_insight": "The graph should be a projection of semantic reality, not a data structure"
      },
      "cim_expert": {
        "agent_id": "ad36a3b",
        "date": "2025-12-29",
        "critical_findings": [
          "CRITICAL: Domain models embedded in GUI instead of using cim-domain-*",
          "2,847-line gui.rs mixing UI, domain, PKI, NATS concerns",
          "NodeType hardcoded to cim-keys specific types",
          "Missing LiftableDomain trait implementation",
          "cim-domain-person and cim-domain-organization are OPTIONAL and NOT USED"
        ]
      },
      "frp_iced_expert": {
        "agent_id": "a1ec441",
        "date": "2025-12-29",
        "frp_compliance": "40%",
        "critical_findings": [
          "Direct mutation in update function",
          "Side effects (port calls) in update logic",
          "Mixed Message types without categorization",
          "No referential transparency",
          "No composability"
        ]
      },
      "tdd_expert": {
        "agent_id": "a999cc2",
        "date": "2025-12-29",
        "critical_findings": [
          "48 tests exist but no GUI/MVI tests",
          "No pure function tests",
          "No property-based tests",
          "Limited event algebra tests",
          "No projection tests"
        ]
      },
      "bdd_expert": {
        "agent_id": "abf0f69",
        "date": "2025-12-29",
        "critical_findings": [
          "No .feature files",
          "No Gherkin scenarios",
          "No executable specifications"
        ]
      },
      "act_expert": {
        "agent_id": "a58ea29",
        "date": "2025-12-29",
        "critical_findings": [
          "NodeType enum must be replaced with DomainNode coproduct preserving injections",
          "LiftableDomain is a FAITHFUL FUNCTOR with monad structure (unit, bind, join)",
          "Graph is a COLIMIT-PRESERVING FUNCTOR from CIM_Domain category",
          "Use Kan Extensions for universal lifting: Lan_D G",
          "Domain composition via natural transformations between functors"
        ],
        "categorical_laws": {
          "functor_laws": ["F(id_A) = id_{F(A)}", "F(g ∘ f) = F(g) ∘ F(f)"],
          "coproduct_universal_property": "[f,g] ∘ ι_A = f, [f,g] ∘ ι_B = g",
          "monad_laws": ["unit(a).bind(f) = f(a)", "m.bind(unit) = m", "associativity"]
        },
        "key_traits": {
          "DomainEntity": "Object in Domain Category - id(), type",
          "LiftableDomain": "Faithful functor - lift(), unlift(), lift_event()",
          "DomainNodeFolder": "Universal property - fold pattern for coproduct",
          "GraphProjectionFunctor": "project_object(), project_morphism(), verify_functor_laws()"
        },
        "key_insight": "The graph is a categorically correct projection - use proper coproducts, Kan extensions, and faithful functors to preserve all domain semantics"
      }
    }
  },

  "metrics": {
    "baseline": {
      "date": "2025-12-29",
      "ddd_validation_checks": "0/5",
      "frp_compliance": "40%",
      "inline_domain_models": 6,
      "inline_locations": [
        "src/domain.rs (Organization, OrganizationUnit, Person)",
        "src/domain_stubs.rs (Organization, OrganizationUnit, Person - DUPLICATE)"
      ],
      "test_count": "26 passed, 46 ignored",
      "test_coverage_gui": "~10%",
      "bdd_scenarios": 0,
      "nodetype_variants": 21,
      "gui_rs_lines": 8058,
      "cim_domain_crates": {
        "in_cargo_toml": ["cim-domain", "cim-domain-location", "cim-domain-person", "cim-domain-organization", "cim-domain-policy", "cim-domain-agent", "cim-graph"],
        "missing_from_cargo_toml": ["cim-domain-spaces", "cim-domain-relationship"],
        "actually_used": false,
        "note": "Dependencies listed but code defines own inline versions. Need to add: cim-domain-spaces (Sprint 6), cim-domain-relationship (Sprint 1)"
      },
      "cim_graph": {
        "status": "in_cargo_toml",
        "used": "partially - for graph structure, but not for domain composition"
      }
    },
    "target": {
      "ddd_validation_checks": "5/5",
      "frp_compliance": "95%",
      "inline_domain_models": 0,
      "test_coverage_gui": ">80%",
      "bdd_scenarios": "18+",
      "nodetype_variants": 0,
      "gui_rs_lines": "<500"
    },
    "current": {
      "date": "2025-12-29",
      "sprint": "7 completed",
      "ddd_validation_checks": "4/5",
      "frp_compliance": "45%",
      "inline_domain_models": 3,
      "note_inline_models": "Bootstrap types kept for JSON loading with conversion functions",
      "cim_domain_types_imported": true,
      "conversion_functions_added": 4,
      "liftable_domain_trait": true,
      "liftable_implementations": 4,
      "note_liftable": "LiftableDomain implemented for Organization, OrganizationUnit, Person, Location",
      "terminology_renamed": {
        "OrganizationGraph": "OrganizationConcept",
        "GraphNode": "ConceptEntity",
        "GraphEdge": "ConceptRelation",
        "GraphMessage": "OrganizationIntent",
        "OrganizationalNodeType": "Injection (removed enum, use coproduct)",
        "total_references_updated": 380
      },
      "test_count": "341 passed",
      "test_coverage_gui": "~15%",
      "bdd_scenarios": 0,
      "nodetype_variants": 0,
      "note_nodetype": "OrganizationalNodeType removed; Injection coproduct has 25 variants with creatable() subset",
      "gui_rs_lines": 8025,
      "lifting_module_lines": 947,
      "commits_total": 13
    }
  },

  "sprints": {
    "sprint_0": {
      "name": "Foundation & Analysis",
      "status": "completed",
      "started": "2025-12-29",
      "completed": "2025-12-29",
      "retrospective": "retrospectives/sprint_0.md",
      "tasks": [
        { "id": "0.1", "description": "Create progress.json tracking file", "status": "completed" },
        { "id": "0.2", "description": "Create REFACTORING_PLAN.md", "status": "completed" },
        { "id": "0.3", "description": "Document current state metrics", "status": "completed" },
        { "id": "0.4", "description": "Verify all cim-domain-* crates are accessible", "status": "completed", "note": "All 7 crates verified: cim-domain, cim-domain-location, cim-domain-person, cim-domain-organization, cim-domain-policy, cim-domain-agent, cim-domain-relationship (needs adding)" },
        { "id": "0.5", "description": "Commit planning documents", "status": "completed" },
        { "id": "0.6", "description": "Get user approval for Sprint 0", "status": "completed" },
        { "id": "0.7", "description": "Consult ACT expert for categorical foundations", "status": "completed", "note": "Added coproduct, functor, Kan extension, monad structures" },
        { "id": "0.8", "description": "Write Sprint 0 retrospective", "status": "completed" }
      ],
      "deliverables": [
        "progress.json initialized",
        "REFACTORING_PLAN.md created with 7 expert consultations",
        "Baseline metrics documented (8058 LOC, 21 NodeType variants, 6 inline models)",
        "Categorical foundations documented (ACT expert)",
        "Sprint 0 retrospective written"
      ]
    },
    "sprint_1": {
      "name": "Extract Domain Layer",
      "status": "completed",
      "started": "2025-12-29",
      "completed": "2025-12-29",
      "retrospective": "retrospectives/sprint_1.md",
      "tasks": [
        { "id": "1.1", "description": "Add cim-domain-relationship to Cargo.toml", "status": "completed" },
        { "id": "1.2", "description": "Enable cim-domain-person feature by default", "status": "completed" },
        { "id": "1.3", "description": "Enable cim-domain-organization feature by default", "status": "completed" },
        { "id": "1.4", "description": "Enable cim-domain-policy feature by default", "status": "completed" },
        { "id": "1.5", "description": "Enable cim-domain-agent feature by default", "status": "completed" },
        { "id": "1.6", "description": "Delete domain_stubs.rs (unused)", "status": "completed" },
        { "id": "1.7", "description": "Import Organization types from cim-domain-organization", "status": "completed" },
        { "id": "1.8", "description": "Import Person types from cim-domain-person", "status": "completed" },
        { "id": "1.9", "description": "Import Relationship types from cim-domain-relationship", "status": "completed" },
        { "id": "1.10", "description": "Add Organization.to_domain() conversion", "status": "completed" },
        { "id": "1.11", "description": "Add Organization.units_to_domain() conversion", "status": "completed" },
        { "id": "1.12", "description": "Add Person.to_domain_person() conversion", "status": "completed" },
        { "id": "1.13", "description": "Add Person.to_employment() conversion", "status": "completed" },
        { "id": "1.14", "description": "Update lib.rs exports", "status": "completed" },
        { "id": "1.15", "description": "Verify compilation (269 tests pass)", "status": "completed" }
      ],
      "acceptance_criteria": [
        "Domain types imported from cim-domain-* crates - ACHIEVED",
        "Bootstrap types documented for JSON loading - ACHIEVED",
        "Conversion functions for bootstrap → domain - ACHIEVED",
        "All 269 tests pass - ACHIEVED",
        "Compilation successful - ACHIEVED"
      ],
      "notes": "Changed approach: instead of removing bootstrap types entirely, we: 1) Import canonical domain types as DomainX, 2) Keep bootstrap types for JSON loading, 3) Add conversion functions. This allows incremental migration without breaking existing functionality."
    },
    "sprint_2": {
      "name": "Rename Graph → Concept",
      "status": "completed",
      "started": "2025-12-29",
      "completed": "2025-12-29",
      "retrospective": "retrospectives/sprint_2.md",
      "tasks": [
        { "id": "2.1", "description": "Rename OrganizationGraph → OrganizationConcept", "status": "completed", "count": 146 },
        { "id": "2.2", "description": "Rename GraphNode → ConceptEntity", "status": "completed", "count": 93 },
        { "id": "2.3", "description": "Rename GraphEdge → ConceptRelation", "status": "completed", "count": 21 },
        { "id": "2.4", "description": "Rename GraphMessage → OrganizationIntent", "status": "completed", "count": 107 },
        { "id": "2.5", "description": "Update all imports and references (367 total)", "status": "completed" },
        { "id": "2.6", "description": "Update markdown documentation", "status": "completed" },
        { "id": "2.7", "description": "Verify compilation", "status": "completed" },
        { "id": "2.8", "description": "Run tests (269 pass)", "status": "completed" }
      ],
      "acceptance_criteria": [
        "No 'OrganizationGraph' in code - ACHIEVED (0 occurrences)",
        "No 'GraphNode' in code - ACHIEVED (0 occurrences)",
        "No 'GraphEdge' in code - ACHIEVED (0 occurrences)",
        "No 'GraphMessage' in code - ACHIEVED (0 occurrences)",
        "All tests pass - ACHIEVED (269 tests)"
      ],
      "notes": "File renaming (graph.rs → concept.rs, graph_*.rs → concept_*.rs) deferred to avoid breaking imports. Current approach renames types while keeping file names for stability."
    },
    "sprint_3": {
      "name": "Remove NodeType Enum",
      "status": "completed",
      "started": "2025-12-30",
      "completed": "2025-12-30",
      "retrospective": "retrospectives/sprint_3.md",
      "tasks": [
        { "id": "3.1", "description": "Analyze all NodeType usages", "status": "completed", "note": "Found OrganizationalNodeType (6 variants) only used in add-node menu" },
        { "id": "3.2", "description": "Add Injection::creatable() method", "status": "completed", "note": "Changed approach: use existing Injection enum instead of new ConceptMember" },
        { "id": "3.3", "description": "Replace OrganizationalNodeType with Injection in Message enum", "status": "completed" },
        { "id": "3.4", "description": "Update menu navigation to use Injection::creatable()", "status": "completed" },
        { "id": "3.5", "description": "Update node creation match arms to use Injection variants", "status": "completed" },
        { "id": "3.6", "description": "Add wildcard arm for non-creatable injection types", "status": "completed" },
        { "id": "3.7", "description": "Import Injection at module level in gui.rs", "status": "completed" },
        { "id": "3.8", "description": "Remove OrganizationalNodeType enum", "status": "completed" },
        { "id": "3.9", "description": "Verify compilation", "status": "completed" },
        { "id": "3.10", "description": "Run tests (331 passed)", "status": "completed" }
      ],
      "acceptance_criteria": [
        "NodeType enum removed - ACHIEVED (OrganizationalNodeType deleted)",
        "Domain identity preserved - ACHIEVED (Injection coproduct has 25 variants)",
        "GraphRenderable trait - DEFERRED (existing DomainNode.injection() provides dispatch)"
      ],
      "notes": "Changed approach from original plan: instead of creating new ConceptMember enum, leveraged existing Injection coproduct which already provides type-safe domain identity. Added creatable() and is_creatable() methods to Injection for menu filtering."
    },
    "sprint_4": {
      "name": "Implement MVI Intent Layer",
      "status": "completed",
      "started": "2025-12-29",
      "completed": "2025-12-30",
      "retrospective": "retrospectives/sprint_4.md",
      "tasks": [
        { "id": "4.1", "description": "MVI module exists (src/mvi/)", "status": "completed", "note": "Already implemented in previous session" },
        { "id": "4.2", "description": "Intent enum with Ui/Port/Domain/System categories", "status": "completed", "note": "79 variants with prefix naming" },
        { "id": "4.3", "description": "Message→Intent bridge (to_intent method)", "status": "completed", "note": "10 conversions implemented" },
        { "id": "4.4", "description": "Update function integration", "status": "completed", "note": "mvi::update() called from gui.rs" },
        { "id": "4.5", "description": "Intent routing in handlers", "status": "completed", "note": "Match arms route by prefix" },
        { "id": "4.6", "description": "Compilation verified", "status": "completed", "note": "0 errors" },
        { "id": "4.7", "description": "Tests pass", "status": "completed", "note": "1126 tests" }
      ],
      "acceptance_criteria": [
        "Intent enum properly categorized - ACHIEVED (Ui*/Domain*/Port*/System* prefixes)",
        "Message→Intent bridge implemented - ACHIEVED (to_intent(), origin_category())",
        "Clear separation of concerns - ACHIEVED (Message for Iced, Intent for MVI)"
      ],
      "notes": "Sprint 4 was discovered to be already complete from previous session. Verified compilation (0 errors) and tests (1126 passed)."
    },
    "sprint_5": {
      "name": "Pure Update Functions",
      "status": "completed",
      "started": "2025-12-29",
      "completed": "2025-12-30",
      "retrospective": "retrospectives/sprint_5.md",
      "tasks": [
        { "id": "5.1", "description": "Pure update function exists (mvi::update)", "status": "completed", "note": "(Model, Intent) -> (Model, Task<Intent>)" },
        { "id": "5.2", "description": "Model uses with_* methods", "status": "completed", "note": "30+ immutable transformations" },
        { "id": "5.3", "description": "Ports injected not called directly", "status": "completed", "note": "Ports passed in, used in Task::perform" },
        { "id": "5.4", "description": "Commands via Task<Intent>", "status": "completed", "note": "Iced Task abstraction" },
        { "id": "5.5", "description": "Model Clone derives for immutability", "status": "completed", "note": "#[derive(Clone)]" },
        { "id": "5.6", "description": "Compilation verified", "status": "completed", "note": "0 errors" },
        { "id": "5.7", "description": "Tests pass", "status": "completed", "note": "1126 tests" }
      ],
      "acceptance_criteria": [
        "Update function is pure - ACHIEVED (returns Model + Task, no mutations)",
        "All side effects via Commands - ACHIEVED (Task::perform for async)",
        "Model uses immutable transformations - ACHIEVED (30+ with_* methods)"
      ],
      "notes": "Sprint 5 was discovered to be already complete from previous session. Verified comprehensive with_* methods and pure update function."
    },
    "sprint_6": {
      "name": "Conceptual Spaces Integration",
      "status": "completed",
      "started": "2025-12-30",
      "completed": "2025-12-30",
      "retrospective": "retrospectives/sprint_6.md",
      "tasks": [
        { "id": "6.1", "description": "Enable conceptual-spaces feature by default", "status": "completed", "note": "Added to default features in Cargo.toml" },
        { "id": "6.2", "description": "Add semantic_position: Option<Point3<f64>> to NodeView", "status": "completed", "note": "3D position for semantic similarity" },
        { "id": "6.3", "description": "Implement stereographic_projection() function", "status": "completed", "note": "Projects unit sphere to 2D plane" },
        { "id": "6.4", "description": "Add knowledge_level: Option<KnowledgeLevel> to NodeView", "status": "completed", "note": "Four-level epistemic state" },
        { "id": "6.5", "description": "Add evidence_score: Option<EvidenceScore> to NodeView", "status": "completed", "note": "Confidence visualization" },
        { "id": "6.6", "description": "Add knowledge_opacity() helper", "status": "completed", "note": "Maps KnowledgeLevel to visual opacity" },
        { "id": "6.7", "description": "Add knowledge_border_style() helper", "status": "completed", "note": "Maps KnowledgeLevel to border style" },
        { "id": "6.8", "description": "Add with_semantic_position() constructor", "status": "completed", "note": "Creates NodeView from 3D position" },
        { "id": "6.9", "description": "Compilation verified", "status": "completed", "note": "0 errors" },
        { "id": "6.10", "description": "Tests pass", "status": "completed", "note": "All tests passing" }
      ],
      "acceptance_criteria": [
        "3D semantic positions supported - ACHIEVED (semantic_position: Option<Point3<f64>>)",
        "Stereographic projection implemented - ACHIEVED (stereographic_projection function)",
        "Knowledge levels visualized - ACHIEVED (knowledge_opacity, knowledge_border_style helpers)"
      ],
      "notes": "Added cim-domain-spaces integration to NodeView. Semantic 3D positions enable spatial similarity visualization. Knowledge levels enable epistemic state visualization."
    },
    "sprint_7": {
      "name": "LiftableDomain Implementation",
      "status": "completed",
      "started": "2025-12-29",
      "completed": "2025-12-29",
      "retrospective": "retrospectives/sprint_7.md",
      "tasks": [
        { "id": "7.1", "description": "Define LiftableDomain trait", "status": "completed", "note": "Faithful functor with lift(), unlift(), injection(), entity_id()" },
        { "id": "7.2", "description": "Implement LiftableDomain for Organization", "status": "completed", "note": "Uses Injection::Organization" },
        { "id": "7.3", "description": "Entity monad already exists in cim-domain", "status": "completed", "note": "Entity<T> has pure(), bind(), map() - reused" },
        { "id": "7.4", "description": "Implement lifting for Person, OrganizationUnit, Location", "status": "completed", "note": "All 4 domain types implemented" },
        { "id": "7.5", "description": "Create unified graph from lifted domains", "status": "completed", "note": "LiftedGraph with merge(), unlift_all(), nodes_by_type()" },
        { "id": "7.6", "description": "Test composition with domain types", "status": "completed", "note": "10 tests including faithfulness verification" },
        { "id": "7.7", "description": "Document composition pattern", "status": "completed", "note": "In retrospectives/sprint_7.md" }
      ],
      "acceptance_criteria": [
        "LiftableDomain trait implemented - ACHIEVED (faithful functor with lift/unlift)",
        "Domains compose correctly - ACHIEVED (LiftedGraph with merge)",
        "Pattern documented - ACHIEVED (retrospective + code comments)"
      ],
      "notes": "Created src/lifting.rs (947 lines) with LiftableDomain trait, LiftedNode, LiftedEdge, LiftedGraph. Implemented for Organization, OrganizationUnit, Person, Location. Added lift_organization_graph convenience function. All 10 tests pass."
    },
    "sprint_8": {
      "name": "Test Infrastructure",
      "status": "not_started",
      "started": null,
      "completed": null,
      "retrospective": null,
      "tasks": [
        { "id": "8.1", "description": "Create tests/unit/gui/ directory structure", "status": "pending" },
        { "id": "8.2", "description": "Add property-based testing with proptest", "status": "pending" },
        { "id": "8.3", "description": "Write pure update function tests", "status": "pending" },
        { "id": "8.4", "description": "Write model immutability tests", "status": "pending" },
        { "id": "8.5", "description": "Write event sourcing property tests", "status": "pending" },
        { "id": "8.6", "description": "Write FRP axiom compliance tests", "status": "pending" },
        { "id": "8.7", "description": "Achieve >80% coverage on src/gui/", "status": "pending" }
      ],
      "acceptance_criteria": [
        "Property tests for update purity",
        "Model immutability verified",
        ">80% test coverage on GUI"
      ]
    },
    "sprint_9": {
      "name": "BDD Specifications",
      "status": "not_started",
      "started": null,
      "completed": null,
      "retrospective": null,
      "tasks": [
        { "id": "9.1", "description": "Create doc/qa/features/ directory", "status": "pending" },
        { "id": "9.2", "description": "Write domain_bootstrap.feature", "status": "pending" },
        { "id": "9.3", "description": "Write person_management.feature", "status": "pending" },
        { "id": "9.4", "description": "Write key_generation.feature", "status": "pending" },
        { "id": "9.5", "description": "Write yubikey_provisioning.feature", "status": "pending" },
        { "id": "9.6", "description": "Write nats_security_bootstrap.feature", "status": "pending" },
        { "id": "9.7", "description": "Write export_manifest.feature", "status": "pending" },
        { "id": "9.8", "description": "Implement step definitions in tests/bdd/", "status": "pending" },
        { "id": "9.9", "description": "Verify all scenarios pass", "status": "pending" }
      ],
      "acceptance_criteria": [
        "Feature files created",
        "Step definitions implemented",
        "All scenarios pass"
      ]
    },
    "sprint_10": {
      "name": "Final Integration & Documentation",
      "status": "not_started",
      "started": null,
      "completed": null,
      "retrospective": null,
      "tasks": [
        { "id": "10.1", "description": "Final code review", "status": "pending" },
        { "id": "10.2", "description": "Update CLAUDE.md with new patterns", "status": "pending" },
        { "id": "10.3", "description": "Update README.md", "status": "pending" },
        { "id": "10.4", "description": "Create architecture diagram", "status": "pending" },
        { "id": "10.5", "description": "Write migration guide for other cim-* modules", "status": "pending" },
        { "id": "10.6", "description": "Final retrospective", "status": "pending" }
      ],
      "acceptance_criteria": [
        "All documentation updated",
        "Architecture diagram created",
        "Migration guide written"
      ]
    }
  },

  "retrospectives": {}
}
